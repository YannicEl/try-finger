rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      // block all read and write access per default
      allow read, write: if false;

      match /users/{userId} {
        // only allow users to get their own user document
        allow get: if request.auth.uid == userId;

        // only allow users to create their own user document with 
        allow create: if request.auth.uid == userId
          && verifyCreateFields([], ["name"]);

        match /joinedChats/{chatId} {
          // only allow users to list their own joinedChats
          allow list: if request.auth.uid == userId;

          // only allow users to create their own joinedChats
          allow create: if request.auth.uid == userId && verifyCreateFields(["name"], []);
        }
      }

      match /chats/{chatId} {
        // allow everybody to create new chats
        allow create: if isAuth() 
          && verifyCreateFields(["name", "members", "creator", "admins"], []) 
          && request.auth.uid == request.resource.data.creator
          && request.auth.uid in request.resource.data.members
          && request.auth.uid in request.resource.data.admins;

        // only allow users to get chats where they are a member
        allow get: if request.auth.uid in resource.data.members

        match /messages/{messageId} {
          // only allow users to read messages of a chat if they are a member
          allow list: if request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.members

          // only allow users to create messages if they are a member of the chat and if the "sender" field == uid from the logged in user
          allow create: if request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.members 
            && request.resource.data.sender == request.auth.uid 
            && verifyCreateFields(["sender", "message"], [])

          // only allow users to delete messages that they wrote
          allow delete: if request.auth.uid == resource.data.sender;

          // only allow users to update the "message" field on their own messages 
          allow update: if request.auth.uid == resource.data.sender 
            && verifyUpdateFields(["message"]);
        }
      }
    }
  }

  // verifies that user is logged in
  function isAuth() {
    return request.auth != null
  }

  // verifies that only required or optional fields are written on create
  function verifyCreateFields(required, optional) {
    // fields "updatedAt" and "createdAt" are always allowed
    let allAllowedFields = ["updatedAt", "createdAt"].concat(required).concat(optional);
    return request.resource.data.keys().hasAll(required) 
      && request.resource.data.keys().hasOnly(allAllowedFields);
  }

  // verifies that only allowed fields are updated
  function verifyUpdateFields(allowed) {
    // field "updatedAt" is always allowed
    let changedFields = request.resource.data.diff(resource.data).affectedKeys();
    return changedFields.hasOnly(allowed.concat(["updatedAt"]));
  }
}